name: Deploy to EC2

on:
  push:
    branches:
      - EC2-Prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code from EC2-Prod branch
        uses: actions/checkout@v3
        with:
          ref: EC2-Prod

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # Navigate to the repository root on EC2
            cd /home/ubuntu/SGC_PORTFOLIO

            # Update the code from the EC2-Prod branch
            git fetch --all
            git checkout EC2-Prod
            git pull origin EC2-Prod

            # Change into the folder that contains the .csproj file
            cd SGC_PORTFOLIO

            # Publish the application using .NET 8.0 (publishing to /app/publish)
            sudo dotnet publish SGC_PORTFOLIO.csproj -c Release -o /app/publish /p:UseAppHost=false

            # Restart the systemd service to load the new build
            sudo systemctl restart sgc_portfolio.service
