name: Deploy to EC2

on:
  push:
    branches:
      - EC2-Prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code from EC2-Prod branch
        uses: actions/checkout@v3
        with:
          ref: EC2-Prod

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # Navigate to the repository root on EC2
            cd /home/ubuntu/SGC_PORTFOLIO

            # Update the code from the EC2-Prod branch
            git fetch --all
            git checkout EC2-Prod
            git pull origin EC2-Prod

            # Change into the folder that contains the .csproj file
            cd SGC_PORTFOLIO

            # Create the output directory with sudo to avoid permission issues
            sudo mkdir -p /app/publish

            # Publish the application using .NET 8.0 with sudo
            sudo dotnet publish SGC_PORTFOLIO.csproj -c Release -o /app/publish /p:UseAppHost=false

            # Kill any running instance of the application (if any)
            sudo pkill -f SGC_PORTFOLIO || true

            # Start the new application in the background using setsid to detach it
            sudo setsid dotnet /app/publish/SGC_PORTFOLIO.dll > /dev/null 2>&1 &
